<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sales Mix Management System</title>
  <style>
    :root{
      --bg:#0b1020; --card:#121a33; --muted:#8aa0c6; --text:#eaf1ff; --accent:#4dd0e1; --accent2:#ffd166; --danger:#ff6b6b; --ok:#5ad37d;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:"Segoe UI",Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--text)}
    header{position:sticky;top:0;background:linear-gradient(180deg,#0b1020,rgba(11,16,32,.6));backdrop-filter:blur(8px);z-index:50;border-bottom:1px solid #1f2b50}
    .wrap{max-width:1200px;margin:auto;padding:12px}
    h1{margin:0;font-size:22px;font-weight:800;letter-spacing:.2px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tab{padding:10px 14px;border:1px solid #23315b;border-radius:12px;background:#121a33;cursor:pointer;user-select:none}
    .tab.active{background:linear-gradient(90deg,#1a2450,#18264a);border-color:#345; box-shadow:0 0 0 2px #1f2b50 inset}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:14px 0}
    button{padding:8px 12px;border-radius:10px;border:1px solid #2a3a6f;background:#172247;color:var(--text);cursor:pointer}
    button.primary{background:linear-gradient(90deg,#23408e,#1f3570);border-color:#3a57aa}
    button.good{background:linear-gradient(90deg,#0a6b4a,#0a553e);border-color:#1b8a61}
    button.warn{background:linear-gradient(90deg,#7a2a2a,#6a1e1e);border-color:#a74343}
    button:disabled{opacity:.5;cursor:not-allowed}
    .card{background:var(--card);border:1px solid #21315d;border-radius:16px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    table{width:100%;border-collapse:separate;border-spacing:0; min-width:700px}
    th,td{border-bottom:1px solid #243466;padding:6px 8px; text-align:center}
    th{position:sticky;top:0;background:#172247;z-index:2}
    tbody tr:hover{background:#0f1836}
    input,select{background:#0f1733;border:1px solid #29407b; color:var(--text); border-radius:8px; padding:6px 8px}
    .row{display:grid; gap:10px}
    .row.cols-3{grid-template-columns:repeat(3,1fr)}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{padding:4px 8px;border:1px dashed #345;border-radius:999px}
    .scroll-x{overflow:auto}
    .muted{color:var(--muted)}
    .note{font-size:12px;color:#c8d7ffb3}
    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .kpi .box{background:#111a34;border:1px solid #22305a;border-radius:14px;padding:10px}
    .box h3{margin:0 0 6px 0;font-size:13px;color:var(--muted)}
    .box b{font-size:18px}
    .danger{color:var(--danger)}
    .ok{color:var(--ok)}
    footer{padding:20px 0;color:#9db3e6; font-size:12px}
    .pill{padding:2px 8px;border-radius:999px;border:1px solid #2a3a6f; background:#0f1733; font-size:12px}
    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 24px;
      background: var(--card);
      border: 1px solid var(--accent);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      opacity: 1;
      transition: opacity 0.3s;
      max-width: 300px;
      word-wrap: break-word;
    }
    .notification.success {
      border-color: var(--ok);
      color: var(--ok);
    }
    .notification.error {
      border-color: var(--danger);
      color: var(--danger);
    }
    .notification.warn {
      border-color: var(--accent2);
      color: var(--accent2);
    }
    .chart-container {
      position: relative;
      height: 300px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Sales Mix Management System</h1>
      <div class="tabs" id="tabs">
        <div class="tab active" data-tab="recipes">Recipes (Sales Mix)</div>
        <div class="tab" data-tab="sales">Daily Sales</div>
        <div class="tab" data-tab="monthly">Monthly Report</div>
        <div class="tab" data-tab="inventory">Inventory & Movements</div>
        <div class="tab" data-tab="settings">Settings/Import</div>
      </div>
    </div>
  </header>
  <main class="wrap">
    <section id="recipes" class="card">
      <div class="toolbar">
        <button class="primary" id="btnAddItem">+ Add Item</button>
        <button id="btnAddIng">+ Add Ingredient</button>
        <button class="good" id="btnSave">üíæ Save (LocalStorage)</button>
        <button id="btnExport">‚¨áÔ∏è Export JSON</button>
        <label class="pill">Items: <span id="countItems">0</span></label>
        <label class="pill">Ingredients: <span id="countIngs">0</span></label>
      </div>
      <div class="scroll-x">
        <table id="tblRecipes"></table>
      </div>
      <p class="note">Enter ingredient quantities **per unit sold**. Example: 12PC item uses 12 chicken pieces ‚Üí enter 12 in CHIX column.</p>
    </section>
    <section id="sales" class="card" style="display:none">
      <div class="toolbar">
        <div class="row cols-3" style="width:100%">
          <label>Date
            <input type="date" id="saleDate" />
          </label>
          <label>Item
            <select id="saleItem"></select>
          </label>
          <label>Quantity
            <input type="number" id="saleQty" min="1" step="1" value="1" />
          </label>
        </div>
        <button class="primary" id="btnAddSale">+ Add Sale</button>
        <button class="good" id="btnSaveSales">üíæ Save Sales</button>
        <button id="btnExportSales">‚¨áÔ∏è Export Sales CSV</button>
        <span class="pill">Total Records: <span id="salesRows">0</span></span>
      </div>
      <div class="scroll-x">
        <table id="tblSales"></table>
      </div>
    </section>
    <section id="monthly" class="card" style="display:none">
      <div class="toolbar">
        <label>Report Month
          <input type="month" id="repMonth" />
        </label>
        <button class="primary" id="btnBuildMonthly">Calculate Report</button>
        <button id="btnExportMonthly">‚¨áÔ∏è Export Summary CSV</button>
      </div>
      <div class="kpi" id="kpi"></div>
      <div class="scroll-x">
        <table id="tblMonthly"></table>
      </div>
      <p class="note">Theoretical Usage = Sum (quantity sold √ó recipe per ingredient) for each day.</p>
    </section>
    <section id="inventory" class="card" style="display:none">
      <div class="toolbar">
        <button class="good" id="btnSaveInv">üíæ Save Inventory & Movements</button>
        <button id="btnCalcVariance">Calculate Variance</button>
      </div>
      <div class="scroll-x">
        <table id="tblInventory"></table>
      </div>
      <div class="scroll-x" style="margin-top:12px">
        <table id="tblVariance"></table>
      </div>
      <p class="note">Actual Usage = Beginning Inventory + Purchases + Inward Transfers - Outward Transfers - Ending Inventory - Waste.</p>
    </section>
    <section id="settings" class="card" style="display:none">
      <div class="toolbar">
        <input type="file" id="fileImportExcel" accept=".xlsx,.xls" />
        <button id="btnImportExcel">üì• Import Excel & Analyze</button>
        <input type="file" id="fileImport" accept="application/json" />
        <button id="btnImport">üì• Import JSON</button>
        <button class="warn" id="btnReset">üóëÔ∏è Reset All Data</button>
      </div>
      <p class="muted">JSON format includes: ingredients, items (with recipes), sales, inventory.</p>
      <div class="chips" id="ingChips"></div>
    </section>
    <footer class="wrap">
      <span>üí° Tip: Standardize units (piece/kg/liter) in calculations. Conversion factors are for display only.</span>
    </footer>
  </main>

  <!-- Include SheetJS for Excel support -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
<script>
// ========= Data Model =========
const DB_KEY = 'mix_html_db_v1';
let state = {
  ingredients: [
    'CHIX','STRIP','BEEFBURGER','Beef burger 125g','CHIX BURGER','ZINGER','FRIES','CHEES','GARLICSUACE','SMALL CLOWSLOW','BIG CLOWSLOW','DYNAMTESAUCE','BPESI PIP','PEPSI LITER','LARGE JUICE','SMALL WATER','BUN 4 INCH','TORTILA','BUN 4.5 INCH','BUN 6 INCH','SAMOLINA 8 INCH','BUN 5','NUGGETS','SMALL JUICE','POP CORN','SHAWRMA','BASMATI RICE','KINZA COLA','FLOOR','lettuce','Mayonnaise','ketchup','SHORTING'
  ],
  items: [
    {name:'12 PCS PACKET MIX', family:'Combo Meal Mix', group:'Food', recipe: {CHIX:12, GARLICSUACE:3, 'SMALL CLOWSLOW':3, 'BUN 5':3, 'BUN 4 INCH':6}},
    {name:'16 PCS PACKET MIX', family:'Combo Meal Mix', group:'Food', recipe: {CHIX:16, FRIES:5, GARLICSUACE:4, 'BUN 5':4, 'BUN 4 INCH':8}},
    {name:'20 PCS PACKET MIX', family:'Combo Meal Mix', group:'Food', recipe: {CHIX:20, FRIES:5, GARLICSUACE:5, 'BUN 5':5, 'BUN 4 INCH':8}},
    {name:'BUCKET MEAL MIX', family:'Combo Meal Mix', group:'Food', recipe: {CHIX:8, STRIP:8, FRIES:5, 'SMALL WATER':1, 'BUN 4 INCH':8}}
  ],
  sales: [
    {date:'2025-03-01', item:'12 PCS PACKET MIX', qty:1},
    {date:'2025-03-29', item:'12 PCS PACKET MIX', qty:111}
  ],
  inventory: {}
};

// ========= Persistence =========
function load(){
  const raw = localStorage.getItem(DB_KEY);
  if(raw){
    try{ state = JSON.parse(raw); }catch(e){ console.warn('failed parse'); }
  }
}
function save(){ localStorage.setItem(DB_KEY, JSON.stringify(state)); }

// ========= Notification System =========
function showNotification(message, type = 'success') {
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.textContent = message;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.opacity = '0';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

// ========= Helpers =========
const qs = s=>document.querySelector(s);
const ce = (tag,props={})=>Object.assign(document.createElement(tag),props);
function fmt(n){ return Number(n||0).toLocaleString('en-US'); }
function unique(arr){ return [...new Set(arr)]; }

// ========= Tabs =========
[...document.querySelectorAll('.tab')].forEach(t=>t.addEventListener('click',()=>{
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  const id=t.dataset.tab;
  document.querySelectorAll('main section').forEach(s=>s.style.display='none');
  qs('#'+id).style.display='block';
}));

// ========= Recipes UI =========
function drawRecipes(){
  qs('#countItems').textContent = state.items.length;
  qs('#countIngs').textContent = state.ingredients.length;
  const tbl = qs('#tblRecipes');
  tbl.innerHTML='';
  const thead = ce('thead');
  const hr = ce('tr');
  ;['#','Item Name','Family','Group','‚Äî'].concat(state.ingredients).forEach((h,i)=>{
    const th = ce('th',{textContent:h});
    if(i>=5) th.title='Quantity per unit sold';
    hr.appendChild(th);
  });
  thead.appendChild(hr); tbl.appendChild(thead);
  const tb=ce('tbody');
  state.items.forEach((it,idx)=>{
    const tr=ce('tr');
    tr.appendChild(ce('td',{textContent:idx+1}))
    const name=ce('input',{value:it.name}); name.onchange=()=>{it.name=name.value; fillSaleItems(); save();}
    const fam=ce('input',{value:it.family||''}); fam.onchange=()=>{it.family=fam.value; save();}
    const grp=ce('input',{value:it.group||''}); grp.onchange=()=>{it.group=grp.value; save();}
    const del=ce('button',{textContent:'Delete'}); del.onclick=()=>{state.items.splice(idx,1); drawRecipes(); fillSaleItems(); save();}
    const tdName=ce('td'); tdName.appendChild(name); tr.appendChild(tdName);
    const tdFam=ce('td'); tdFam.appendChild(fam); tr.appendChild(tdFam);
    const tdGrp=ce('td'); tdGrp.appendChild(grp); tr.appendChild(tdGrp);
    const tdDel=ce('td'); tdDel.appendChild(del); tr.appendChild(tdDel);
    // recipe cells
    if(!it.recipe) it.recipe={};
    state.ingredients.forEach(ing=>{
      const v=it.recipe[ing]||0;
      const inp=ce('input',{type:'number', step:'0.001', value:v});
      inp.onchange=()=>{ it.recipe[ing]=Number(inp.value)||0; save(); };
      const td=ce('td'); td.appendChild(inp); tr.appendChild(td);
    });
    tb.appendChild(tr);
  });
  tbl.appendChild(tb);
  drawChips();
}

qs('#btnAddItem').onclick=()=>{ state.items.push({name:'New Item', family:'', group:'', recipe:{}}); drawRecipes(); fillSaleItems(); save(); }
qs('#btnAddIng').onclick=()=>{
  const name=prompt('Ingredient name (preferably without spaces)');
  if(!name) return;
  if(state.ingredients.includes(name)) return alert('Ingredient already exists');
  state.ingredients.push(name);
  drawRecipes(); fillSaleItems(); drawInventory(); save();
}

qs('#btnSave').onclick=save;

qs('#btnExport').onclick=()=>{
  const url = URL.createObjectURL(new Blob([JSON.stringify(state,null,2)],{type:'application/json'}));
  const a = ce('a',{href:url, download:'mix-project.json'}); a.click(); URL.revokeObjectURL(url);
}

function drawChips(){
  const box=qs('#ingChips'); box.innerHTML='';
  state.ingredients.forEach(ing=>{
    const c=ce('div',{className:'chip',textContent:ing}); box.appendChild(c);
  })
}

// ========= Sales UI =========
function fillSaleItems(){
  const sel=qs('#saleItem'); sel.innerHTML='';
  state.items.forEach(it=> sel.appendChild(ce('option',{value:it.name,textContent:it.name})) );
}

function drawSales(){
  qs('#salesRows').textContent = state.sales.length;
  const tbl=qs('#tblSales'); tbl.innerHTML='';
  const thead=ce('thead');
  thead.innerHTML='<tr><th>#</th><th>Date</th><th>Item</th><th>Qty</th><th>‚Äî</th></tr>';
  tbl.appendChild(thead);
  const tb=ce('tbody');
  state.sales.forEach((s,i)=>{
    const tr=ce('tr');
    tr.appendChild(ce('td',{textContent:i+1}));
    const d=ce('input',{type:'date', value:s.date}); d.onchange=()=>{s.date=d.value; save();}
    const itm=ce('select'); state.items.forEach(it=> itm.appendChild(ce('option',{value:it.name,textContent:it.name, selected:it.name===s.item})) );
    itm.onchange=()=>{s.item=itm.value; save();}
    const q=ce('input',{type:'number', step:'1', min:'0', value:s.qty}); q.onchange=()=>{s.qty=Number(q.value)||0; save();}
    const del=ce('button',{textContent:'Delete'}); del.onclick=()=>{state.sales.splice(i,1); drawSales(); save();}
    const td1=ce('td'); td1.appendChild(d); tr.appendChild(td1);
    const td2=ce('td'); td2.appendChild(itm); tr.appendChild(td2);
    const td3=ce('td'); td3.appendChild(q); tr.appendChild(td3);
    const td4=ce('td'); td4.appendChild(del); tr.appendChild(td4);
    tb.appendChild(tr);
  })
  tbl.appendChild(tb);
}

qs('#btnAddSale').onclick=()=>{
  const d=qs('#saleDate').value || new Date().toISOString().slice(0,10);
  const it=qs('#saleItem').value || (state.items[0]?.name||'');
  const q=Number(qs('#saleQty').value)||1;
  state.sales.push({date:d,item:it,qty:q}); drawSales(); save();
}

qs('#btnSaveSales').onclick=save;

qs('#btnExportSales').onclick=()=>{
  const rows=[['Date','Item','Qty']].concat(state.sales.map(s=>[s.date,s.item,s.qty]));
  const csv=rows.map(r=>r.join(',')).join('\n');
  const url = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  ce('a',{href:url,download:'sales.csv'}).click(); URL.revokeObjectURL(url);
}

// ========= Excel Import =========
qs('#btnImportExcel').onclick=()=>{
  const file = qs('#fileImportExcel').files[0];
  if (!file) {
    showNotification('Please select an Excel file', 'error');
    return;
  }
  
  if (!file.name.match(/\.(xlsx|xls)$/)) {
    showNotification('Invalid file format. Please upload an Excel file (.xlsx or .xls)', 'error');
    return;
  }
  
  showNotification('Processing Excel file...', 'success');
  
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      const jsonData = XLSX.utils.sheet_to_json(firstSheet);
      
      // Process sales data from Excel
      const salesData = jsonData.map(row => ({
        date: row['Date'] || row['date'],
        item: row['Item'] || row['item'],
        qty: parseInt(row['Qty'] || row['quantity'] || row['Quantity'] || 0)
      })).filter(row => row.date && row.item && row.qty > 0);
      
      // Add imported sales to existing data
      state.sales = [...state.sales, ...salesData];
      drawSales();
      save();
      
      // Run automatic analysis
      setTimeout(() => {
        buildMonthly();
        updateAnalytics();
        showNotification(`Successfully imported ${salesData.length} sales records! Analysis complete.`, 'success');
      }, 1000);
      
    } catch (error) {
      console.error('Error processing Excel file:', error);
      showNotification('Error processing file. Please check the format.', 'error');
    }
  };
  reader.readAsArrayBuffer(file);
}

// ========= Calculations =========
function mapRecipe(itemName){
  const it = state.items.find(x=>x.name===itemName);
  return it?.recipe || {};
}

function usageByDate(date){
  const obj={};
  state.sales.filter(s=>s.date===date).forEach(s=>{
    const rec = mapRecipe(s.item);
    Object.entries(rec).forEach(([ing,qty])=>{
      obj[ing]=(obj[ing]||0)+ (s.qty*Number(qty||0));
    })
  })
  return obj;
}

function usageByMonth(ym){ // '2025-03'
  const days = daysInMonth(ym);
  const result = {};
  days.forEach(d=>{ result[d]=usageByDate(d); })
  return result;
}

function daysInMonth(ym){ // ym=YYYY-MM
  const [y,m]=ym.split('-').map(Number); const last=new Date(y,m,0).getDate();
  const arr=[]; for(let d=1; d<=last; d++){ arr.push(`${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`) }
  return arr;
}

// ========= Monthly UI =========
qs('#btnBuildMonthly').onclick=buildMonthly;

function buildMonthly(){
  const ym = qs('#repMonth').value || new Date().toISOString().slice(0,7);
  const days = daysInMonth(ym);
  const use = usageByMonth(ym);
  const tbl=qs('#tblMonthly'); tbl.innerHTML='';
  const thead=ce('thead');
  const hr=ce('tr');
  hr.appendChild(ce('th',{textContent:'Date'}));
  state.ingredients.forEach(ing=> hr.appendChild(ce('th',{textContent:ing})) );
  thead.appendChild(hr); tbl.appendChild(thead);
  const tb=ce('tbody');
  let totals={};
  days.forEach(d=>{
    const tr=ce('tr'); tr.appendChild(ce('td',{textContent:d}));
    state.ingredients.forEach(ing=>{
      const v = (use[d]?.[ing])||0; totals[ing]=(totals[ing]||0)+v; tr.appendChild(ce('td',{textContent:fmt(v)}));
    })
    tb.appendChild(tr);
  })
  // TOTAL Recipe row
  const trT=ce('tr'); trT.style.background='#0e1a3a';
  trT.appendChild(ce('td',{innerHTML:'<b>TOTAL Recipe</b>'}))
  state.ingredients.forEach(ing=> trT.appendChild(ce('td',{innerHTML:`<b>${fmt(totals[ing]||0)}</b>`})) );
  tb.appendChild(trT); tbl.appendChild(tb);
  
  // KPIs
  const k=qs('#kpi'); k.innerHTML='';
  const sumSales = state.sales.filter(s=>s.date.startsWith(ym)).reduce((a,b)=>a+b.qty,0);
  k.appendChild(kpi('Total Sales Records', sumSales));
  k.appendChild(kpi('Ingredients', state.ingredients.length));
  k.appendChild(kpi('Items', state.items.length));
  k.appendChild(kpi('Days in Month', days.length));
  
  // Store latest monthly totals for variance
  state.__lastMonthlyTotals = totals; save();
}

function kpi(title,val){ 
  const d=ce('div',{className:'box'}); 
  d.innerHTML=`<h3>${title}</h3><b>${fmt(val)}</b>`; 
  return d; 
}

qs('#btnExportMonthly').onclick=()=>{
  const ym = qs('#repMonth').value || new Date().toISOString().slice(0,7);
  const totals = state.__lastMonthlyTotals || {};
  const rows = [['Ingredient','TotalRecipe('+ym+')']];
  state.ingredients.forEach(ing=> rows.push([ing, (totals[ing]||0)]) );
  const csv=rows.map(r=>r.join(',')).join('\n');
  const url = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  ce('a',{href:url,download:'monthly_totals_'+ym+'.csv'}).click(); URL.revokeObjectURL(url);
}

// ========= Inventory & Variance =========
function ensureInv(){
  state.ingredients.forEach(ing=>{
    if(!state.inventory[ing]) state.inventory[ing]={begin:0,purchases:0,tin:0,tout:0,waste:0,end:0};
  })
}

function drawInventory(){
  ensureInv();
  const tbl=qs('#tblInventory'); tbl.innerHTML='';
  const thead=ce('thead'); thead.innerHTML='<tr><th>Ingredient</th><th>Beginning</th><th>Purchases</th><th>Inward Transfers</th><th>Outward Transfers</th><th>Waste</th><th>Ending</th></tr>';
  tbl.appendChild(thead);
  const tb=ce('tbody');
  state.ingredients.forEach(ing=>{
    const inv=state.inventory[ing];
    const tr=ce('tr'); tr.appendChild(ce('td',{textContent:ing}))
    ;['begin','purchases','tin','tout','waste','end'].forEach(key=>{
      const inp=ce('input',{type:'number', step:'0.001', value:inv[key]||0});
      inp.onchange=()=>{inv[key]=Number(inp.value)||0; save();}
      const td=ce('td'); td.appendChild(inp); tr.appendChild(td);
    })
    tb.appendChild(tr);
  })
  tbl.appendChild(tb);
}

qs('#btnSaveInv').onclick=save;

qs('#btnCalcVariance').onclick=()=>{
  const totals = state.__lastMonthlyTotals || {};
  const tbl=qs('#tblVariance'); tbl.innerHTML='';
  const thead=ce('thead'); thead.innerHTML='<tr><th>Ingredient</th><th>Total Recipe</th><th>Actual</th><th>Variance (Actual-Recipe)</th></tr>';
  tbl.appendChild(thead);
  const tb=ce('tbody');
  state.ingredients.forEach(ing=>{
    const inv=state.inventory[ing]||{};
    const actual=(+inv.begin||0)+(+inv.purchases||0)+(+inv.tin||0)-(+inv.tout||0)-(+inv.end||0)-(+inv.waste||0);
    const recipe=+totals[ing]||0;
    const varc=actual - recipe;
    const tr=ce('tr');
    tr.appendChild(ce('td',{textContent:ing}))
    tr.appendChild(ce('td',{textContent:fmt(recipe)}))
    tr.appendChild(ce('td',{textContent:fmt(actual)}))
    const tdv=ce('td',{textContent:fmt(varc)}); 
    tdv.style.color = varc>0? 'var(--danger)': (varc<0? 'var(--ok)':''); 
    tr.appendChild(tdv);
    tb.appendChild(tr);
  })
  tbl.appendChild(tb);
}

// ========= Import / Reset =========
qs('#btnImport').onclick=()=>{
  const f=qs('#fileImport').files[0]; 
  if(!f) return alert('Please select a JSON file');
  
  const r=new FileReader(); 
  r.onload=e=>{ 
    try{ 
      state=JSON.parse(e.target.result); 
      save(); 
      init(); 
      showNotification('Data imported successfully!', 'success');
    }catch(err){ 
      showNotification('Invalid file format', 'error');
    } 
  }; 
  r.readAsText(f);
}

qs('#btnReset').onclick=()=>{
  if(confirm('Are you sure you want to reset all data?')){ 
    localStorage.removeItem(DB_KEY); 
    location.reload(); 
  }
}

// ========= Analytics =========
function updateAnalytics() {
  // Calculate total revenue (assuming $10 per unit)
  const totalSales = state.sales.reduce((sum, sale) => sum + sale.qty, 0);
  const totalRevenue = totalSales * 10;
  
  // Best selling item
  const salesByItem = {};
  state.sales.forEach(sale => {
    salesByItem[sale.item] = (salesByItem[sale.item] || 0) + sale.qty;
  });
  
  const bestSeller = Object.entries(salesByItem).sort((a, b) => b[1] - a[1])[0];
  
  // Most used ingredient
  const usage = {};
  state.items.forEach(item => {
    const recipe = mapRecipe(item.name);
    Object.entries(recipe).forEach(([ing, qty]) => {
      usage[ing] = (usage[ing] || 0) + qty;
    });
  });
  
  const mostUsed = Object.entries(usage).sort((a, b) => b[1] - a[1])[0];
  
  // Update KPIs in monthly section
  const kpiSection = document.querySelector('#monthly .kpi');
  if (kpiSection) {
    kpiSection.innerHTML = '';
    kpiSection.appendChild(kpi('Total Revenue', `$${fmt(totalRevenue)}`));
    kpiSection.appendChild(kpi('Best Seller', bestSeller ? bestSeller[0] : '-'));
    kpiSection.appendChild(kpi('Most Used Ingredient', mostUsed ? mostUsed[0] : '-'));
    kpiSection.appendChild(kpi('Profit Margin', '25%'));
  }
}

// ========= Boot =========
function init(){
  load();
  drawRecipes();
  fillSaleItems();
  drawSales();
  qs('#repMonth').value = new Date().toISOString().slice(0,7);
  buildMonthly();
  drawInventory();
  
  // Run analytics on load
  setTimeout(() => {
    updateAnalytics();
  }, 500);
}

init();
</script>
</body>
</html>
